#!/bin/bash
# üîÑ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é..."
echo ""

# –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "üì• –®–∞–≥ 1/6: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
cd ~/telegram-bot-admin
git pull origin sync/cleanup/2025-10-29
echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω"
echo ""

# –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üì¶ –®–∞–≥ 2/6: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
docker cp backend/dist/. tg-backend:/app/dist/ 2>/dev/null || echo "‚ö†Ô∏è  Backend –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
docker cp backend/init-settings-simple.js tg-backend:/app/init-settings-simple.js 2>/dev/null || echo "‚ö†Ô∏è  Backend –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
echo ""

# –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üîÑ –®–∞–≥ 3/6: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose -f docker-compose.lightweight.yml down
docker compose -f docker-compose.lightweight.yml up -d
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15
echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"
echo ""

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üîç –®–∞–≥ 4/6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose -f docker-compose.lightweight.yml ps
echo ""

# –®–∞–≥ 5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo "‚öôÔ∏è  –®–∞–≥ 5/6: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
docker compose -f docker-compose.lightweight.yml exec -T backend node init-settings-simple.js
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
echo ""

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo "üìã –®–∞–≥ 6/6: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend..."
docker compose -f docker-compose.lightweight.yml logs backend | tail -30
echo ""

echo "üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "   1. –ê–¥–º–∏–Ω–∫–∞: http://89.35.55.254:8080"
echo "   2. API: http://89.35.55.254:3000/api/docs"
echo ""
echo "üîß –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –±–∞–∑–µ:"
sudo -u postgres psql -d u3315562_developer -t -c "SELECT COUNT(*) FROM settings;" 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"
echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ!"

